#!/bin/sh -eu

BOX=${1:-./dist/build/box/box}

export BOX_STORE=test/cli/basic/v2
export BOX_USER=pwadler
export BOX_IDENTITY=~/.ssh/endofunctor_rsa

$BOX -v

$BOX --version

if $BOX ip --name "mincom"; then exit 1; fi
if $BOX; then exit 1; fi
$BOX ip --name "mincom.*"
$BOX ip --instance "i-a057m17c"
$BOX ip --client "acme"
$BOX ip --flavour "lab"
$BOX ip --external --flavour "lab"
$BOX ip --external --instance "i-a057m17c"
$BOX ip --name "mincom.*" --instance "i-932db44b"
$BOX ip --name "mincom.*" --instance "i-932db44b" --client "mincom"
$BOX ip --name "mincom.*" --instance "i-932db44b" --client "mincom" --flavour "land"
if $BOX ip --name "acme.*" --instance "i-932db44b" --client "mincom" --flavour "land"; then exit 1; fi
if $BOX ip --name "mincom.*" --instance "i-932db44c" --client "mincom" --flavour "land"; then exit 1; fi
if $BOX ip --name "mincom.*" --instance "i-932db44b" --client "acme" --flavour "land"; then exit 1; fi
if $BOX ip --name "mincom.*" --instance "i-932db44b" --client "mincom" --flavour "hub"; then exit 1; fi

EXPECT='["ssh","-o","ProxyCommand=ssh -i '$BOX_IDENTITY' '$BOX_USER'@54.1.1.6 nc %h %p 2>/dev/null","-o","HostKeyAlias=box.acme.lab.kermit.brown.717.jump","'$BOX_USER'@192.31.14.3"]'
ACTUAL=$($BOX --dry-run ssh --client "acme" --flavour "lab")

if [ "$EXPECT" != "$ACTUAL" ]; then
  echo "expected: $EXPECT"
  echo " but was: $ACTUAL"
  exit 1
fi
