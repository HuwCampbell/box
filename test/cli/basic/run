#!/bin/sh -eu

BOX=${1:-./dist/build/box/box}

export BOX_STORE=test/cli/basic/v2
export BOX_USER=pwadler
export BOX_IDENTITY=~/.ssh/endofunctor_rsa

$BOX -v

$BOX --version

if $BOX ip ::nomatches; then exit 1; fi
if $BOX; then exit 1; fi
$BOX ip mincom
$BOX ip acme
$BOX ip :lab
$BOX ip --external :lab
$BOX ip mincom:land
$BOX ip mincom:land:zoot
$BOX ip mincom:land:zoot.golden
$BOX ip mincom:land:golden
$BOX ip ::zoot.golden
if $BOX ip acme:land; then exit 1; fi
if $BOX ip mincom:land:brown; then exit 1; fi
if $BOX ip mincom:land:kermit; then exit 1; fi
if $BOX ip mincom:hub; then exit 1; fi

EXPECT='["ssh","-o","ProxyCommand=ssh -i '$BOX_IDENTITY' '$BOX_USER'@54.1.1.6 nc %h %p 2>/dev/null","-o","HostKeyAlias=box.acme.lab.kermit.brown.717.jump","'$BOX_USER'@192.31.14.3"]'
ACTUAL=$($BOX --dry-run ssh acme:lab)

if [ "$EXPECT" != "$ACTUAL" ]; then
  echo "expected: $EXPECT"
  echo " but was: $ACTUAL"
  exit 1
fi
